<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-Oasis Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-indicator {
            animation: pulse 2s infinite;
        }
        .detection-box {
            transition: all 0.3s ease;
        }
        .detection-box:hover {
            transform: scale(1.02);
        }
        .live-indicator {
            animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .frame-container {
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        /* Ensure proper scrolling for page and modals */
        html, body {
            height: 100%;
            overflow: auto !important;
            scroll-behavior: smooth;
        }
        
        /* Custom scrollbar styling */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
            border: 2px solid #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Modal specific scrolling */
        .modal-content {
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
        
        /* Add shadow when content is scrollable */
        .modal-content::-webkit-scrollbar-track {
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
        }
        
        /* Ensure modal content is scrollable on mobile */
        @media (max-width: 640px) {
            .modal-content {
                max-height: 95vh;
                -webkit-overflow-scrolling: touch;
            }
            
            /* Compact spacing on mobile */
            .mobile-compact .bg-gray-50 {
                padding: 12px !important;
                margin-bottom: 16px !important;
            }
            
            .mobile-compact .space-y-6 > * + * {
                margin-top: 16px !important;
            }
            
            .mobile-compact .space-y-4 > * + * {
                margin-top: 12px !important;
            }
        }
        
        /* Enhanced scrollbar for modal content */
        .modal-scrollable {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f7fafc;
        }
        
        .modal-scrollable::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-scrollable::-webkit-scrollbar-track {
            background: #f7fafc;
            border-radius: 4px;
        }
        
        .modal-scrollable::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }
        
        .modal-scrollable::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        /* Enhanced toggle switch styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e7eb;
            transition: .4s;
            border-radius: 24px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .toggle-switch input:checked + .toggle-slider {
            background-color: #3b82f6;
        }
        
        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }
        
        /* Improved visibility for the existing peer-based toggles */
        .peer:checked ~ .peer-checked\:bg-blue-600 {
            background-color: #3b82f6 !important;
        }
        
        .peer-checked\:after\:translate-x-full:checked ~ div:after {
            transform: translateX(100%) !important;
        }
        
        /* Additional toggle enhancement */
        .toggle-slider:hover {
            background-color: #d1d5db;
        }
        
        .toggle-switch input:checked + .toggle-slider:hover {
            background-color: #2563eb;
        }
        
        .toggle-slider:before {
            border: 1px solid #e5e7eb;
        }
        
        /* Force visibility of toggle elements */
        .toggle-switch,
        .toggle-slider,
        .toggle-slider:before {
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
        }
        
        /* Mirror effect for camera video */
        .mirror-video {
            transform: scaleX(-1);
        }
        
        /* Fixed overlay container to prevent page shake */
        .video-overlay-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 10;
        }
        
        /* Fixed badge container */
        .badges-container {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 280px;
            min-height: 400px;
            pointer-events: none;
            z-index: 20;
        }
        
        /* Individual badge with smooth transitions */
        .person-badge {
            position: absolute;
            width: 260px;
            height: 50px;
            transition: all 0.3s ease-in-out;
            pointer-events: auto;
            transform-origin: top right;
        }
        
        /* Status overlay - fixed position */
        .status-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 300px;
            height: 80px;
            pointer-events: none;
            z-index: 20;
        }
        
        /* Tracking info - fixed position */
        .tracking-info {
            position: absolute;
            top: 100px;
            left: 10px;
            width: 280px;
            height: 30px;
            pointer-events: none;
            z-index: 20;
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Video container to maintain aspect ratio */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .video-container img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        /* Smooth animations for badges */
        .badge-enter {
            opacity: 0;
            transform: translateX(100%) scale(0.8);
        }
        
        .badge-enter-active {
            opacity: 1;
            transform: translateX(0) scale(1);
            transition: all 0.3s ease-out;
        }
        
        .badge-exit {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
        
        .badge-exit-active {
            opacity: 0;
            transform: translateX(100%) scale(0.8);
            transition: all 0.3s ease-in;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Main Dashboard Component
        function PPEDashboard() {
            const [systemStatus, setSystemStatus] = useState({
                running: false,
                stats: { frames_processed: 0, fps: 0, connection_status: 'Disconnected' },
                detections: { people: [], ppe_items: [], compliance_status: 'UNKNOWN' }
            });
            const [currentFrame, setCurrentFrame] = useState(null);
            const [logs, setLogs] = useState([]);
            const [liveLogs, setLiveLogs] = useState([]);
            const [config, setConfig] = useState(null);
            const [unknownPeople, setUnknownPeople] = useState([]);
            const [showAddPersonModal, setShowAddPersonModal] = useState(false);
            const [selectedUnknown, setSelectedUnknown] = useState(null);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [availableCameras, setAvailableCameras] = useState([]);
            const [currentCamera, setCurrentCamera] = useState('rtsp');
            const [knownPeople, setKnownPeople] = useState([]);
            const [showManagePeopleModal, setShowManagePeopleModal] = useState(false);
            const [showAddPersonDirectModal, setShowAddPersonDirectModal] = useState(false);
            const socketRef = useRef(null);

            useEffect(() => {
                // Initialize Socket.IO connection
                socketRef.current = io();
                
                socketRef.current.on('connect', () => {
                    console.log('Connected to server');
                });

                socketRef.current.on('detection_update', (data) => {
                    setCurrentFrame(data.frame);
                    setSystemStatus({
                        running: true,
                        stats: data.stats,
                        detections: data.detections
                    });
                    
                    // Check if there are new unknown people detections
                    if (data.detections.people && data.detections.people.some(p => p.name === 'Unknown Person')) {
                        fetchUnknownPeople();
                    }
                });

                socketRef.current.on('status_update', (data) => {
                    setSystemStatus(prev => ({
                        ...prev,
                        running: data.running,
                        stats: data.stats
                    }));
                });

                // Fetch initial data
                fetchStatus();
                fetchConfig();
                fetchLogs();
                fetchLiveLogs();
                fetchUnknownPeople();
                fetchCameras();
                fetchKnownPeople();
                
                // Set up interval to fetch live logs every 2 seconds
                const liveLogsInterval = setInterval(fetchLiveLogs, 2000);

                return () => {
                    if (socketRef.current) {
                        socketRef.current.disconnect();
                    }
                    clearInterval(liveLogsInterval);
                };
            }, []);

            const fetchStatus = async () => {
                try {
                    const response = await fetch('/api/status');
                    const data = await response.json();
                    setSystemStatus(data);
                } catch (error) {
                    console.error('Error fetching status:', error);
                }
            };

            const fetchConfig = async () => {
                try {
                    const response = await fetch('/api/config');
                    const data = await response.json();
                    setConfig(data);
                } catch (error) {
                    console.error('Error fetching config:', error);
                }
            };

            const fetchLogs = async () => {
                try {
                    const response = await fetch('/api/logs');
                    const data = await response.json();
                    setLogs(data);
                } catch (error) {
                    console.error('Error fetching logs:', error);
                }
            };

            const fetchLiveLogs = async () => {
                try {
                    const response = await fetch('/api/logs/live');
                    const data = await response.json();
                    setLiveLogs(data);
                } catch (error) {
                    console.error('Error fetching live logs:', error);
                }
            };

            const clearLogs = async () => {
                if (!confirm('Are you sure you want to clear all logs? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    const response = await fetch('/api/logs/clear', { method: 'DELETE' });
                    const data = await response.json();
                    
                    if (data.success) {
                        setLogs([]);
                        setLiveLogs([]);
                        alert('Logs cleared successfully');
                    } else {
                        alert('Error clearing logs: ' + data.error);
                    }
                } catch (error) {
                    console.error('Error clearing logs:', error);
                    alert('Failed to clear logs');
                }
            };

            const fetchUnknownPeople = async () => {
                try {
                    const response = await fetch('/api/unknown-people');
                    const data = await response.json();
                    // Handle new API response format with tracking info
                    setUnknownPeople(data.unknown_people || []);
                    
                    // Store tracking info if needed for future use
                    if (data.tracking && data.tracking.length > 0) {
                        console.log(`[INFO] Currently tracking ${data.tracking.length} potential unknown people`);
                        data.tracking.forEach(track => {
                            console.log(`[INFO] Track ${track.track_id}: ${track.frame_count}/${track.required_frames} frames (${track.progress.toFixed(1)}% complete)`);
                        });
                    }
                } catch (error) {
                    console.error('Error fetching unknown people:', error);
                }
            };

            const fetchCameras = async () => {
                try {
                    const response = await fetch('/api/cameras');
                    const data = await response.json();
                    if (data.success) {
                        setAvailableCameras(data.cameras);
                        setCurrentCamera(data.current_camera);
                    }
                } catch (error) {
                    console.error('Error fetching cameras:', error);
                }
            };

            const fetchKnownPeople = async () => {
                try {
                    const response = await fetch('/api/known-people');
                    const data = await response.json();
                    if (data.success) {
                        setKnownPeople(data.people);
                    }
                } catch (error) {
                    console.error('Error fetching known people:', error);
                }
            };

            const switchCamera = async (cameraId) => {
                try {
                    const response = await fetch('/api/camera/switch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ camera_id: cameraId })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        setCurrentCamera(cameraId);
                        fetchStatus(); // Refresh status
                        alert(data.message);
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error switching camera:', error);
                    alert('Error switching camera');
                }
            };

            const addPersonToDatabase = async (unknownId, name, action = 'new') => {
                try {
                    const response = await fetch('/api/add-person', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ unknown_id: unknownId, name: name, action: action })
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert(data.message);
                        fetchUnknownPeople();
                        fetchKnownPeople(); // Refresh known people list
                        setShowAddPersonModal(false);
                        setSelectedUnknown(null);
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error adding person:', error);
                    alert('Error adding person to database');
                }
            };

            const dismissUnknownPerson = async (unknownId) => {
                try {
                    const response = await fetch(`/api/dismiss-unknown/${unknownId}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        fetchUnknownPeople();
                    } else {
                        alert('Error: ' + data.message);
                    }
                } catch (error) {
                    console.error('Error dismissing unknown person:', error);
                }
            };

            const updateDetectionSettings = async (settings) => {
                try {
                    const response = await fetch('/api/config/detection', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        fetchConfig(); // Refresh config
                        return { success: true, message: data.message };
                    } else {
                        return { success: false, message: data.message };
                    }
                } catch (error) {
                    console.error('Error updating settings:', error);
                    return { success: false, message: 'Failed to update settings' };
                }
            };

            const startSystem = async () => {
                try {
                    const response = await fetch('/api/start', { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        fetchStatus();
                    }
                } catch (error) {
                    console.error('Error starting system:', error);
                }
            };

            const stopSystem = async () => {
                try {
                    const response = await fetch('/api/stop', { method: 'POST' });
                    const data = await response.json();
                    if (data.success) {
                        fetchStatus();
                        setCurrentFrame(null);
                    }
                } catch (error) {
                    console.error('Error stopping system:', error);
                }
            };

            const addPersonDirect = async (formData) => {
                try {
                    const response = await fetch('/api/add-person-direct', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        fetchKnownPeople();
                        return { success: true, message: data.message };
                    } else {
                        return { success: false, message: data.message };
                    }
                } catch (error) {
                    console.error('Error adding person directly:', error);
                    return { success: false, message: 'Failed to add person' };
                }
            };

            const addTrainingImageDirect = async (formData) => {
                try {
                    const response = await fetch('/api/add-training-image', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        fetchKnownPeople();
                        return { success: true, message: data.message };
                    } else {
                        return { success: false, message: data.message };
                    }
                } catch (error) {
                    console.error('Error adding training image:', error);
                    return { success: false, message: 'Failed to add training image' };
                }
            };

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <header className="gradient-bg text-white shadow-lg">
                        <div className="container mx-auto px-6 py-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-4">
                                    <i className="fas fa-hard-hat text-3xl"></i>
                                    <div>
                                        <h1 className="text-2xl font-bold">S-Oasis</h1>
                                        <p className="text-blue-200">Real-time Safety Monitoring</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <SystemStatusIndicator status={systemStatus} />
                                    <CameraSelector 
                                        cameras={availableCameras}
                                        currentCamera={currentCamera}
                                        onSwitchCamera={switchCamera}
                                    />
                                    <button 
                                        onClick={() => setShowManagePeopleModal(true)}
                                        className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors"
                                        title="Manage People Database"
                                    >
                                        <i className="fas fa-users"></i>
                                        <span>Manage People</span>
                                    </button>
                                    <button 
                                        onClick={() => setShowSettingsModal(true)}
                                        className="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors"
                                        title="Detection Settings"
                                    >
                                        <i className="fas fa-cog"></i>
                                        <span>Settings</span>
                                    </button>
                                    <SystemControls 
                                        running={systemStatus.running}
                                        onStart={startSystem}
                                        onStop={stopSystem}
                                    />
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Main Content */}
                    <div className="container mx-auto px-6 py-8">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            {/* Live Feed */}
                            <div className="lg:col-span-2">
                                <LiveFeed 
                                    frame={currentFrame} 
                                    running={systemStatus.running}
                                    currentCamera={availableCameras.find(cam => cam.id === currentCamera)}
                                    detections={systemStatus.detections || { people: [], ppe_items: [] }}
                                    stats={systemStatus.stats || {}}
                                    unknownPeople={unknownPeople}
                                />
                            </div>

                            {/* Detection Results - DISABLED for cleaner UI */}
                            <div className="space-y-6">
                                {/* <DetectionResults detections={systemStatus.detections} /> */}
                                <SystemStats stats={systemStatus.stats} />
                            </div>
                        </div>

                        {/* Bottom Section */}
                        <div className="mt-8 space-y-8">
                            {/* Unknown People Section */}
                            <UnknownPeopleManager 
                                unknownPeople={unknownPeople}
                                enabled={config?.detection?.detect_unknown_people ?? true}
                                onAddPerson={(unknown) => {
                                    setSelectedUnknown(unknown);
                                    setShowAddPersonModal(true);
                                }}
                                onDismiss={dismissUnknownPerson}
                                onSettings={() => setShowSettingsModal(true)}
                            />
                            
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <ConfigDisplay config={config} />
                                <LogsDisplay 
                                    logs={logs} 
                                    liveLogs={liveLogs}
                                    onRefresh={fetchLogs} 
                                    onRefreshLive={fetchLiveLogs}
                                    onClear={clearLogs}
                                />
                            </div>
                        </div>
                        
                        {/* Add Person Modal */}
                        {showAddPersonModal && selectedUnknown && (
                                                            <AddPersonModal 
                                    unknown={selectedUnknown}
                                    knownPeople={knownPeople}
                                    onAdd={(name, action) => addPersonToDatabase(selectedUnknown.id, name, action)}
                                    onClose={() => {
                                        setShowAddPersonModal(false);
                                        setSelectedUnknown(null);
                                    }}
                                />
                        )}
                        
                        {/* Settings Modal */}
                        {showSettingsModal && config && (
                            <SettingsModal 
                                config={config}
                                onUpdate={updateDetectionSettings}
                                onClose={() => setShowSettingsModal(false)}
                            />
                        )}

                        {/* Manage People Modal */}
                        {showManagePeopleModal && (
                            <ManagePeopleModal 
                                knownPeople={knownPeople}
                                onAddNew={() => {
                                    setShowManagePeopleModal(false);
                                    setShowAddPersonDirectModal(true);
                                }}
                                onAddTraining={(personName) => {
                                    setShowManagePeopleModal(false);
                                    setShowAddPersonDirectModal(true);
                                }}
                                onClose={() => setShowManagePeopleModal(false)}
                                onRefresh={fetchKnownPeople}
                            />
                        )}

                        {/* Add Person Direct Modal */}
                        {showAddPersonDirectModal && (
                            <AddPersonDirectModal 
                                knownPeople={knownPeople}
                                onAdd={(formData, isTrainingImage) => {
                                    if (isTrainingImage) {
                                        return addTrainingImageDirect(formData);
                                    } else {
                                        return addPersonDirect(formData);
                                    }
                                }}
                                onClose={() => setShowAddPersonDirectModal(false)}
                                onSuccess={() => {
                                    setShowAddPersonDirectModal(false);
                                    fetchKnownPeople();
                                }}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // System Status Indicator Component
        function SystemStatusIndicator({ status }) {
            const getStatusColor = () => {
                if (!status.running) return 'bg-gray-500';
                if (status.stats.connection_status === 'Connected') return 'bg-green-500';
                if (status.stats.connection_status === 'Failed') return 'bg-red-500';
                return 'bg-yellow-500';
            };

            const getStatusText = () => {
                if (!status.running) return 'Stopped';
                return status.stats.connection_status || 'Unknown';
            };

            return (
                <div className="flex items-center space-x-2">
                    <div className={`w-3 h-3 rounded-full ${getStatusColor()} ${status.running ? 'status-indicator' : ''}`}></div>
                    <span className="text-sm font-medium">{getStatusText()}</span>
                </div>
            );
        }

        // Camera Selector Component
        function CameraSelector({ cameras, currentCamera, onSwitchCamera }) {
            if (!cameras || cameras.length <= 1) return null;

            return (
                <div className="flex items-center space-x-2">
                    <i className="fas fa-video text-blue-200"></i>
                    <select 
                        value={currentCamera}
                        onChange={(e) => onSwitchCamera(e.target.value)}
                        className="bg-blue-700 text-white border border-blue-600 rounded px-3 py-1 text-sm focus:outline-none focus:border-blue-400"
                    >
                        {cameras.map(camera => (
                            <option key={camera.id} value={camera.id}>
                                {camera.name}
                            </option>
                        ))}
                    </select>
                </div>
            );
        }

        // System Controls Component
        function SystemControls({ running, onStart, onStop }) {
            return (
                <div className="flex space-x-2">
                    {!running ? (
                        <button 
                            onClick={onStart}
                            className="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors"
                        >
                            <i className="fas fa-play"></i>
                            <span>Start</span>
                        </button>
                    ) : (
                        <button 
                            onClick={onStop}
                            className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg flex items-center space-x-2 transition-colors"
                        >
                            <i className="fas fa-stop"></i>
                            <span>Stop</span>
                        </button>
                    )}
                </div>
            );
        }

        // Live Feed Component
        function LiveFeed({ frame, running, currentCamera, detections = { people: [], ppe_items: [] }, stats = {}, unknownPeople = [] }) {
            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <div className="flex items-center justify-between mb-4">
                        <div>
                            <h2 className="text-xl font-bold text-gray-800">Live Camera Feed</h2>
                            {currentCamera && (
                                <p className="text-sm text-gray-600">{currentCamera.name}</p>
                            )}
                        </div>
                        {running && (
                            <div className="flex items-center space-x-2">
                                <div className="w-2 h-2 bg-red-500 rounded-full live-indicator"></div>
                                <span className="text-sm text-red-600 font-medium">LIVE</span>
                            </div>
                        )}
                    </div>
                    <div className="video-container bg-gray-900">
                        {frame ? (
                            <>
                                <img 
                                    src={`data:image/jpeg;base64,${frame}`} 
                                    alt="Live Feed"
                                    className="w-full h-auto max-h-96 object-contain"
                                />
                                <div className="video-overlay-container">
                                    {/* Status Overlay - Always fixed position */}
                                    <div className="status-overlay">
                                        <div className={`w-full h-full rounded-lg flex flex-col justify-center px-4 ${
                                            detections.compliance_status === 'COMPLIANT' ? 'bg-green-600' : 
                                            detections.compliance_status === 'NON-COMPLIANT' ? 'bg-red-600' : 
                                            'bg-gray-600'
                                        }`}>
                                            <div className="text-white font-bold text-lg">
                                                Status: {detections.compliance_status || 'UNKNOWN'}
                                            </div>
                                            <div className="text-white text-sm">
                                                People: {detections.people?.length || 0} | FPS: {stats.fps?.toFixed(1) || '0.0'}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Tracking Info - DISABLED to fix layout issues */}
                                    {/* <div className={`tracking-info ${unknownPeople.length > 0 ? 'opacity-100' : 'opacity-0'}`}>
                                        <div className="w-full h-full bg-gray-700 bg-opacity-90 rounded-lg flex items-center px-3">
                                            <div className="text-white text-sm">
                                                Tracking: {unknownPeople.length} potential unknown
                                            </div>
                                        </div>
                                    </div> */}
                                    
                                    {/* People Badges Container - Fixed positioning */}
                                    <div className="badges-container">
                                        {detections.people?.map((person, index) => {
                                            const badgeStyle = {
                                                top: (index * 60) + 'px',
                                                zIndex: 30 + index
                                            };
                                            return (
                                            <div 
                                                key={person.name + '-' + index}
                                                className="person-badge"
                                                style={badgeStyle}
                                            >
                                                <div className={`w-full h-full rounded-lg flex items-center px-3 border-2 border-white ${
                                                    person.name === "Unknown Person" || person.name.startsWith("Unknown #") 
                                                        ? 'bg-orange-500' 
                                                        : 'bg-green-500'
                                                }`}>
                                                    {/* Avatar Circle */}
                                                    <div className="w-9 h-9 bg-white rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                                        <div className={`w-6 h-6 rounded-full ${
                                                            person.name === "Unknown Person" || person.name.startsWith("Unknown #") 
                                                                ? 'bg-orange-500' 
                                                                : 'bg-green-500'
                                                        }`}></div>
                                                    </div>
                                                    
                                                    {/* Text Content */}
                                                    <div className="flex-1 min-w-0">
                                                        <div className="text-white font-semibold text-sm truncate">
                                                            {person.name.length > 18 ? person.name.slice(0, 15) + '...' : person.name}
                                                        </div>
                                                        <div className="text-white text-xs opacity-90">
                                                            {person.name === "Unknown Person" || person.name.startsWith("Unknown #") ? 'UNKNOWN' : 'IDENTIFIED'} ({person.recognition_confidence?.toFixed(0) || 0}%)
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="flex items-center justify-center h-96 text-gray-500">
                                <div className="text-center">
                                    <i className="fas fa-video-slash text-6xl mb-4"></i>
                                    <p className="text-lg">
                                        {running ? 'Connecting to camera...' : 'Start system to view live feed'}
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Detection Results Component
        function DetectionResults({ detections }) {
            const getComplianceColor = (status) => {
                switch (status) {
                    case 'COMPLIANT': return 'text-green-600 bg-green-100';
                    case 'NON-COMPLIANT': return 'text-red-600 bg-red-100';
                    default: return 'text-gray-600 bg-gray-100';
                }
            };

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">Detection Results</h3>
                    
                    {/* Compliance Status */}
                    <div className={`p-3 rounded-lg mb-4 ${getComplianceColor(detections.compliance_status)}`}>
                        <div className="flex items-center justify-between">
                            <span className="font-medium">Status:</span>
                            <span className="font-bold">{detections.compliance_status}</span>
                        </div>
                        {detections.compliance_details && (
                            <div className="text-sm mt-2">
                                Compliance: {detections.compliance_details.compliance_percentage?.toFixed(1)}%
                            </div>
                        )}
                    </div>

                    {/* People are now shown as badges on the video overlay - no need to duplicate here */}

                    {/* PPE Items */}
                    <div>
                        <h4 className="font-medium text-gray-700 mb-2">PPE Items ({detections.ppe_items?.length || 0})</h4>
                        <div className="space-y-2">
                            {detections.ppe_items?.map((item, index) => (
                                <div key={index} className={`flex items-center justify-between p-2 rounded ${item.required ? 'bg-green-50' : 'bg-gray-50'}`}>
                                    <span className="text-sm">{item.label}</span>
                                    <div className="flex items-center space-x-2">
                                        <span className="text-xs text-gray-500">{(item.confidence * 100).toFixed(1)}%</span>
                                        {item.required && <i className="fas fa-check-circle text-green-500"></i>}
                                    </div>
                                </div>
                            )) || <p className="text-gray-500 text-sm">No PPE detected</p>}
                        </div>
                    </div>
                </div>
            );
        }

        // System Stats Component
        function SystemStats({ stats }) {
            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">System Statistics</h3>
                    <div className="space-y-3">
                        <div className="flex justify-between">
                            <span className="text-gray-600">Frames Processed:</span>
                            <span className="font-medium">{stats.frames_processed?.toLocaleString() || 0}</span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-600">Current FPS:</span>
                            <span className="font-medium">{stats.fps?.toFixed(1) || '0.0'}</span>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-gray-600">Connection:</span>
                            <span className={`font-medium ${stats.connection_status === 'Connected' ? 'text-green-600' : 'text-red-600'}`}>
                                {stats.connection_status || 'Unknown'}
                            </span>
                        </div>
                        {stats.start_time && (
                            <div className="flex justify-between">
                                <span className="text-gray-600">Started:</span>
                                <span className="font-medium text-sm">{new Date(stats.start_time).toLocaleTimeString()}</span>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Config Display Component
        function ConfigDisplay({ config }) {
            if (!config) return null;

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-4">System Configuration</h3>
                    <div className="space-y-4">
                        <div>
                            <h4 className="font-medium text-gray-700 mb-2">Camera Settings</h4>
                            <div className="text-sm space-y-1 text-gray-600">
                                <p>IP: {config.camera?.ip}</p>
                                <p>Port: {config.camera?.port}</p>
                                <p>Stream: {config.camera?.stream_path}</p>
                            </div>
                        </div>
                        <div>
                            <h4 className="font-medium text-gray-700 mb-2">Detection Settings</h4>
                            <div className="text-sm space-y-1 text-gray-600">
                                <p>YOLO Confidence: {config.detection?.yolo_confidence}</p>
                                <p>Face Tolerance: {config.detection?.face_tolerance}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Logs Display Component
        function LogsDisplay({ logs, liveLogs, onRefresh, onRefreshLive, onClear }) {
            const [activeTab, setActiveTab] = useState('system');

            return (
                <div className="bg-white rounded-xl shadow-lg p-6">
                    <div className="flex items-center justify-between mb-4">
                        <h3 className="text-lg font-bold text-gray-800">Detection Logs</h3>
                        <div className="flex items-center space-x-2">
                            <button 
                                onClick={activeTab === 'system' ? onRefresh : onRefreshLive}
                                className="text-blue-600 hover:text-blue-800 text-sm px-2 py-1 rounded"
                                title="Refresh logs"
                            >
                                <i className="fas fa-refresh mr-1"></i>
                                Refresh
                            </button>
                            <button 
                                onClick={onClear}
                                className="text-red-600 hover:text-red-800 text-sm px-2 py-1 rounded"
                                title="Clear all logs"
                            >
                                <i className="fas fa-trash mr-1"></i>
                                Clear
                            </button>
                        </div>
                    </div>
                    
                    {/* Tab Navigation */}
                    <div className="flex mb-4 border-b border-gray-200">
                        <button 
                            onClick={() => setActiveTab('system')}
                            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                                activeTab === 'system' 
                                    ? 'text-blue-600 border-blue-600' 
                                    : 'text-gray-500 border-transparent hover:text-gray-700'
                            }`}
                        >
                            System Logs ({logs.length})
                        </button>
                        <button 
                            onClick={() => setActiveTab('live')}
                            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                                activeTab === 'live' 
                                    ? 'text-blue-600 border-blue-600' 
                                    : 'text-gray-500 border-transparent hover:text-gray-700'
                            }`}
                        >
                            <div className="flex items-center space-x-2">
                                <span>Live Detections ({liveLogs.length})</span>
                                {liveLogs.length > 0 && (
                                    <div className="w-2 h-2 bg-green-500 rounded-full live-indicator"></div>
                                )}
                            </div>
                        </button>
                    </div>

                    {/* Tab Content */}
                    <div className="max-h-64 overflow-y-auto space-y-2">
                        {activeTab === 'system' ? (
                            logs.length > 0 ? logs.map((log, index) => (
                                <div key={index} className="text-sm p-3 bg-gray-50 rounded-lg">
                                    <div className="flex justify-between items-start mb-2">
                                        <span className="font-medium">{log.people_detected || 'No people'}</span>
                                        <span className={`px-2 py-1 rounded text-xs font-medium ${
                                            log.ppe_status === 'COMPLIANT' 
                                                ? 'bg-green-100 text-green-800' 
                                                : 'bg-red-100 text-red-800'
                                        }`}>
                                            {log.ppe_status}
                                        </span>
                                    </div>
                                    {log.present_ppe && (
                                        <div className="text-xs text-green-600 mb-1">
                                            <i className="fas fa-check mr-1"></i>
                                            Present: {log.present_ppe}
                                        </div>
                                    )}
                                    {log.missing_ppe && (
                                        <div className="text-xs text-red-600 mb-1">
                                            <i className="fas fa-times mr-1"></i>
                                            Missing: {log.missing_ppe}
                                        </div>
                                    )}
                                    <div className="text-xs text-gray-500">
                                        {new Date(log.timestamp).toLocaleString()}
                                    </div>
                                </div>
                            )) : (
                                <p className="text-gray-500 text-sm text-center py-4">No system logs available</p>
                            )
                        ) : (
                            liveLogs.length > 0 ? liveLogs.slice().reverse().map((event, index) => (
                                <div key={event.id} className="text-sm p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="flex items-center space-x-2">
                                            <i className="fas fa-user text-blue-600"></i>
                                            <span className="font-medium text-blue-800">{event.name}</span>
                                        </div>
                                        <span className="text-xs text-blue-600 font-medium">{event.time_display}</span>
                                    </div>
                                    <div className="flex justify-between items-center text-xs">
                                        <div className="text-gray-600">
                                            <span>Detection: {event.detection_confidence?.toFixed(1)}%</span>
                                            <span className="ml-2">Recognition: {event.recognition_confidence?.toFixed(1)}%</span>
                                        </div>
                                        <span className="bg-blue-200 text-blue-800 px-2 py-1 rounded">
                                            {event.event_type === 'face_detection' ? 'Face' : event.event_type}
                                        </span>
                                    </div>
                                </div>
                            )) : (
                                <p className="text-gray-500 text-sm text-center py-4">
                                    No live detections yet
                                    <br />
                                    <span className="text-xs">Live events will appear here when people are detected</span>
                                </p>
                            )
                        )}
                    </div>
                </div>
            );
        }

        // Unknown People Manager Component
        function UnknownPeopleManager({ unknownPeople, enabled, onAddPerson, onDismiss, onSettings }) {
            const pendingPeople = unknownPeople.filter(p => !p.added_to_database);
            
            // Don't show anything if disabled and no pending people
            if (!enabled && pendingPeople.length === 0) {
                return null;
            }
            
            if (pendingPeople.length === 0) return null;

            return (
                <div className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-orange-500">
                    <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center space-x-3">
                            <i className="fas fa-user-question text-2xl text-orange-600"></i>
                            <div>
                                <h3 className="text-lg font-bold text-gray-800">Unknown People Detected</h3>
                                <p className="text-sm text-gray-600">{pendingPeople.length} new unknown person(s) detected</p>
                                {!enabled && (
                                    <p className="text-sm text-amber-600 font-medium">
                                        <i className="fas fa-pause-circle mr-1"></i>
                                        Detection currently disabled
                                    </p>
                                )}
                            </div>
                        </div>
                        <div className="flex items-center space-x-3">
                            {!enabled && (
                                <button 
                                    onClick={onSettings}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm font-medium transition-colors"
                                >
                                    <i className="fas fa-cog mr-1"></i>
                                    Enable Detection
                                </button>
                            )}
                            <div className="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-medium">
                                Needs Attention
                            </div>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        {pendingPeople.map((person) => (
                            <div key={person.id} className="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors">
                                <div className="aspect-square mb-3 rounded-lg overflow-hidden bg-gray-200">
                                    <img 
                                        src={`data:image/jpeg;base64,${person.image_data}`}
                                        alt="Unknown Person"
                                        className="w-full h-full object-cover"
                                    />
                                </div>
                                
                                <div className="text-sm space-y-2">
                                    <p className="text-gray-600">
                                        <strong>First Seen:</strong><br />
                                        {new Date(person.timestamp).toLocaleString()}
                                    </p>
                                    <p className="text-gray-600">
                                        <strong>Last Seen:</strong><br />
                                        {new Date(person.last_seen).toLocaleString()}
                                    </p>
                                </div>
                                
                                <div className="flex space-x-2 mt-4">
                                    <button 
                                        onClick={() => onAddPerson(person)}
                                        className="flex-1 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm font-medium transition-colors"
                                    >
                                        <i className="fas fa-user-plus mr-1"></i>
                                        Add Person
                                    </button>
                                    <button 
                                        onClick={() => onDismiss(person.id)}
                                        className="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded text-sm transition-colors"
                                        title="Dismiss"
                                    >
                                        <i className="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        // Settings Modal Component
        function SettingsModal({ config, onUpdate, onClose }) {
            const [activeTab, setActiveTab] = useState('detection');
            const [settings, setSettings] = useState({
                detect_unknown_people: config.detection.detect_unknown_people || true,
                detect_ppe: config.detection.detect_ppe !== undefined ? config.detection.detect_ppe : true,
                unknown_detection_cooldown: config.detection.unknown_detection_cooldown || 30,
                yolo_confidence: config.detection.yolo_confidence || 0.5,
                face_tolerance: config.detection.face_tolerance || 0.6,
                detection_interval: config.camera.detection_interval || 1,
                use_low_resolution: config.camera.use_low_resolution || false
            });
            const [saving, setSaving] = useState(false);
            const [isControlling, setIsControlling] = useState(false);

            const tabs = [
                { id: 'detection', name: 'Detection', icon: '🎯' },
                { id: 'performance', name: 'Performance', icon: '⚡' },
                { id: 'camera', name: 'Camera Controls', icon: '📹' },
                { id: 'advanced', name: 'Advanced', icon: '⚙️' }
            ];

            const handleSave = async () => {
                setSaving(true);
                try {
                    const result = await onUpdate(settings);
                    if (result.success) {
                        alert('Settings updated successfully!');
                        onClose();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Failed to save settings');
                } finally {
                    setSaving(false);
                }
            };

            const handleReset = () => {
                setSettings({
                    detect_unknown_people: config.detection.detect_unknown_people || true,
                    detect_ppe: config.detection.detect_ppe !== undefined ? config.detection.detect_ppe : true,
                    unknown_detection_cooldown: config.detection.unknown_detection_cooldown || 30,
                    yolo_confidence: config.detection.yolo_confidence || 0.5,
                    face_tolerance: config.detection.face_tolerance || 0.6,
                    detection_interval: config.camera.detection_interval || 1,
                    use_low_resolution: config.camera.use_low_resolution || false
                });
            };

            const sendCameraCommand = async (action, params = {}) => {
                setIsControlling(true);
                try {
                    const response = await fetch('/api/camera/control', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action, params })
                    });
                    const data = await response.json();
                    
                    if (!data.success) {
                        alert('Camera control error: ' + data.message);
                    }
                } catch (error) {
                    console.error('Camera control error:', error);
                    alert('Failed to control camera');
                } finally {
                    setIsControlling(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-2 sm:p-4 z-50">
                    <div className="bg-white rounded-xl max-w-4xl w-full max-h-[95vh] sm:max-h-[90vh] flex flex-col modal-content shadow-2xl">
                        
                        {/* Header */}
                        <div className="flex items-center justify-between p-4 sm:p-6 border-b border-gray-200 flex-shrink-0">
                            <h3 className="text-lg sm:text-xl font-bold text-gray-800">System Settings</h3>
                            <button 
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700 transition-colors p-1"
                            >
                                <i className="fas fa-times text-lg sm:text-xl"></i>
                            </button>
                        </div>

                        {/* Tab Navigation */}
                        <div className="flex border-b border-gray-200 flex-shrink-0 overflow-x-auto">
                            {tabs.map(tab => (
                                <button
                                    key={tab.id}
                                    onClick={() => setActiveTab(tab.id)}
                                    className={`flex-1 min-w-0 px-2 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium text-center border-b-2 transition-colors ${ 
                                        activeTab === tab.id 
                                        ? 'border-blue-500 text-blue-600 bg-blue-50' 
                                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                                    }`}
                                >
                                    <span className="mr-1 sm:mr-2">{tab.icon}</span>
                                    <span className="">{tab.name}</span>
                                </button>
                            ))}
                        </div>

                        {/* Scrollable Content */}
                        <div className="flex-1 overflow-y-auto p-4 sm:p-6 min-h-0 modal-scrollable bg-gray-50">
                            
                            {/* Detection Tab */}
                            {activeTab === 'detection' && (
                                <div className="space-y-6">
                                    {/* Unknown Person Detection */}
                                    <div className="bg-white p-4 sm:p-6 rounded-xl border border-gray-200 shadow-sm">
                                        <h4 className="font-medium text-gray-800 mb-3 flex items-center">
                                            <i className="fas fa-user-question text-orange-600 mr-2"></i>
                                            Unknown Person Detection
                                        </h4>
                                        
                                        <div className="flex items-center justify-between mb-4">
                                            <p className="text-sm text-gray-600 max-w-xs">
                                                Automatically detect and capture unknown people for database addition
                                            </p>
                                            <label className="toggle-switch">
                                                <input 
                                                    type="checkbox"
                                                    checked={settings.detect_unknown_people}
                                                    onChange={(e) => setSettings({...settings, detect_unknown_people: e.target.checked})}
                                                />
                                                <span className="toggle-slider"></span>
                                            </label>
                                        </div>
                                        
                                        {settings.detect_unknown_people && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Detection Cooldown: {settings.unknown_detection_cooldown} seconds
                                                </label>
                                                <input 
                                                    type="range"
                                                    min="5"
                                                    max="120"
                                                    step="5"
                                                    value={settings.unknown_detection_cooldown}
                                                    onChange={(e) => setSettings({...settings, unknown_detection_cooldown: parseInt(e.target.value)})}
                                                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                />
                                                <div className="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>5s</span>
                                                    <span>2min</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* PPE Detection Settings */}
                                    <div className="bg-white p-4 sm:p-6 rounded-xl border border-gray-200 shadow-sm">
                                        <h4 className="font-medium text-gray-800 mb-3 flex items-center">
                                            <i className="fas fa-hard-hat text-green-600 mr-2"></i>
                                            Safety Detection Settings
                                        </h4>
                                        
                                        <div className="flex items-center justify-between mb-4">
                                            <p className="text-sm text-gray-600 max-w-xs">
                                                Enable safety equipment detection (disable for face-only mode)
                                            </p>
                                            <label className="toggle-switch">
                                                <input 
                                                    type="checkbox"
                                                    checked={settings.detect_ppe}
                                                    onChange={(e) => setSettings({...settings, detect_ppe: e.target.checked})}
                                                />
                                                <span className="toggle-slider"></span>
                                            </label>
                                        </div>
                                        
                                        {settings.detect_ppe && (
                                            <div className="space-y-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        YOLO Confidence Threshold: {(settings.yolo_confidence * 100).toFixed(0)}%
                                                    </label>
                                                    <input 
                                                        type="range"
                                                        min="0.1"
                                                        max="1.0"
                                                        step="0.05"
                                                        value={settings.yolo_confidence}
                                                        onChange={(e) => setSettings({...settings, yolo_confidence: parseFloat(e.target.value)})}
                                                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                    />
                                                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                                                        <span>10% (More detections)</span>
                                                        <span>100% (Fewer, more confident)</span>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Face Recognition Settings */}
                                    <div className="bg-white p-4 sm:p-6 rounded-xl border border-gray-200 shadow-sm">
                                        <h4 className="font-medium text-gray-800 mb-3 flex items-center">
                                            <i className="fas fa-face-smile text-purple-600 mr-2"></i>
                                            Face Recognition Settings
                                        </h4>
                                        
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Face Tolerance: {(settings.face_tolerance * 100).toFixed(0)}%
                                            </label>
                                            <input 
                                                type="range"
                                                min="0.1"
                                                max="1.0"
                                                step="0.05"
                                                value={settings.face_tolerance}
                                                onChange={(e) => setSettings({...settings, face_tolerance: parseFloat(e.target.value)})}
                                                className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                            />
                                            <div className="flex justify-between text-xs text-gray-500 mt-1">
                                                <span>10% (Strict matching)</span>
                                                <span>100% (Loose matching)</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Current PPE Requirements */}
                                    <div className="bg-white p-4 sm:p-6 rounded-xl border border-gray-200 shadow-sm">
                                        <h4 className="font-medium text-gray-800 mb-3 flex items-center">
                                            <i className="fas fa-list-check text-blue-600 mr-2"></i>
                                            Required PPE Items
                                        </h4>
                                        <div className="flex flex-wrap gap-2">
                                            {config.detection.required_ppe.map((item, index) => (
                                                <span key={index} className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
                                                    {item}
                                                </span>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Performance Tab */}
                            {activeTab === 'performance' && (
                                <div className="space-y-6">
                                    <div className="bg-white p-4 sm:p-6 rounded-xl border border-gray-200 shadow-sm">
                                        <h4 className="font-medium text-gray-800 mb-3 flex items-center">
                                            <i className="fas fa-tachometer-alt text-red-600 mr-2"></i>
                                            Performance Optimization
                                        </h4>
                                        
                                        <div className="space-y-4">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-sm font-medium text-gray-700">Use Lower Resolution Stream</p>
                                                    <p className="text-xs text-gray-500">Better performance, lower quality</p>
                                                </div>
                                                <label className="toggle-switch">
                                                    <input 
                                                        type="checkbox"
                                                        checked={settings.use_low_resolution}
                                                        onChange={(e) => setSettings({...settings, use_low_resolution: e.target.checked})}
                                                    />
                                                    <span className="toggle-slider"></span>
                                                </label>
                                            </div>
                                            
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Detection Interval: Process every {settings.detection_interval} frame(s)
                                                </label>
                                                <input 
                                                    type="range"
                                                    min="1"
                                                    max="5"
                                                    step="1"
                                                    value={settings.detection_interval}
                                                    onChange={(e) => setSettings({...settings, detection_interval: parseInt(e.target.value)})}
                                                    className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                                />
                                                <div className="flex justify-between text-xs text-gray-500 mt-1">
                                                    <span>Every frame (slower)</span>
                                                    <span>Every 5th frame (faster)</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Camera Controls Tab */}
                            {activeTab === 'camera' && (
                                <div className="bg-white p-4 sm:p-6 rounded-xl border border-gray-200 shadow-sm">
                                    <h4 className="font-medium text-gray-800 mb-4 flex items-center">
                                        <i className="fas fa-video text-blue-600 mr-2"></i>
                                        PTZ Camera Controls
                                    </h4>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {/* Pan/Tilt Grid */}
                                        <div className="mb-4 sm:mb-0">
                                            <h5 className="font-medium text-gray-700 mb-3 text-center">Pan & Tilt</h5>
                                            <div className="grid grid-cols-3 gap-2 max-w-40 sm:max-w-32 mx-auto">
                                                <button onClick={() => sendCameraCommand('pan_tilt', {x: -0.1, y: 0.1})} disabled={isControlling} className="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-800 p-2 rounded text-lg" title="↖"><i className="fas fa-arrow-up-left"></i></button>
                                                <button onClick={() => sendCameraCommand('pan_tilt', {x: 0, y: 0.1})} disabled={isControlling} className="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-800 p-2 rounded text-lg" title="↑"><i className="fas fa-arrow-up"></i></button>
                                                <button onClick={() => sendCameraCommand('pan_tilt', {x: 0.1, y: 0.1})} disabled={isControlling} className="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-800 p-2 rounded text-lg" title="↗"><i className="fas fa-arrow-up-right"></i></button>
                                                <button onClick={() => sendCameraCommand('pan_tilt', {x: -0.1, y: 0})} disabled={isControlling} className="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-800 p-2 rounded text-lg" title="←"><i className="fas fa-arrow-left"></i></button>
                                                <button onClick={() => sendCameraCommand('preset', {action: 'goto', presetId: 1})} disabled={isControlling} className="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white p-2 rounded text-lg" title="Home"><i className="fas fa-home"></i></button>
                                                <button onClick={() => sendCameraCommand('pan_tilt', {x: 0.1, y: 0})} disabled={isControlling} className="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-800 p-2 rounded text-lg" title="→"><i className="fas fa-arrow-right"></i></button>
                                                <button onClick={() => sendCameraCommand('pan_tilt', {x: -0.1, y: -0.1})} disabled={isControlling} className="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-800 p-2 rounded text-lg" title="↙"><i className="fas fa-arrow-down-left"></i></button>
                                                <button onClick={() => sendCameraCommand('pan_tilt', {x: 0, y: -0.1})} disabled={isControlling} className="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-800 p-2 rounded text-lg" title="↓"><i className="fas fa-arrow-down"></i></button>
                                                <button onClick={() => sendCameraCommand('pan_tilt', {x: 0.1, y: -0.1})} disabled={isControlling} className="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-800 p-2 rounded text-lg" title="↘"><i className="fas fa-arrow-down-right"></i></button>
                                            </div>
                                        </div>

                                        {/* Zoom Controls */}
                                        <div className="mb-4 sm:mb-0">
                                            <h5 className="font-medium text-gray-700 mb-3 text-center">Zoom</h5>
                                            <div className="flex flex-col space-y-2 justify-center">
                                                <button onClick={() => sendCameraCommand('zoom', {direction: 'in'})} disabled={isControlling} className="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-800 px-3 sm:px-4 py-2 rounded text-sm flex items-center justify-center"><i className="fas fa-search-plus mr-2"></i> Zoom In</button>
                                                <button onClick={() => sendCameraCommand('zoom', {direction: 'out'})} disabled={isControlling} className="bg-gray-200 hover:bg-gray-300 disabled:bg-gray-100 text-gray-800 px-3 sm:px-4 py-2 rounded text-sm flex items-center justify-center"><i className="fas fa-search-minus mr-2"></i> Zoom Out</button>
                                            </div>
                                        </div>

                                        {/* Preset Controls */}
                                        <div>
                                            <h5 className="font-medium text-gray-700 mb-3 text-center">Presets</h5>
                                            <div className="space-y-2">
                                                <div className="flex space-x-2">
                                                    <button onClick={() => sendCameraCommand('preset', {action: 'set', presetId: 1})} disabled={isControlling} className="flex-1 bg-blue-100 hover:bg-blue-200 disabled:bg-gray-100 text-blue-800 py-2 px-3 rounded text-sm">💾 Save 1</button>
                                                    <button onClick={() => sendCameraCommand('preset', {action: 'goto', presetId: 1})} disabled={isControlling} className="flex-1 bg-green-100 hover:bg-green-200 disabled:bg-gray-100 text-green-800 py-2 px-3 rounded text-sm">📍 Go to 1</button>
                                                </div>
                                                <div className="flex space-x-2">
                                                    <button onClick={() => sendCameraCommand('preset', {action: 'set', presetId: 2})} disabled={isControlling} className="flex-1 bg-blue-100 hover:bg-blue-200 disabled:bg-gray-100 text-blue-800 py-2 px-3 rounded text-sm">💾 Save 2</button>
                                                    <button onClick={() => sendCameraCommand('preset', {action: 'goto', presetId: 2})} disabled={isControlling} className="flex-1 bg-green-100 hover:bg-green-200 disabled:bg-gray-100 text-green-800 py-2 px-3 rounded text-sm">📍 Go to 2</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Advanced Tab */}
                            {activeTab === 'advanced' && (
                                <div className="space-y-4 sm:space-y-6">
                                    <div className="bg-white p-4 sm:p-6 rounded-xl border border-gray-200 shadow-sm">
                                        <h4 className="font-medium text-gray-800 mb-3 flex items-center">
                                            <i className="fas fa-cogs text-gray-600 mr-2"></i>
                                            Advanced Configuration
                                        </h4>
                                        <p className="text-sm text-gray-600 mb-4">
                                            Additional system settings and diagnostics will be available here in future updates.
                                        </p>
                                        <div className="bg-blue-50 p-3 rounded border-l-4 border-blue-400">
                                            <p className="text-sm text-blue-700">
                                                <i className="fas fa-info-circle mr-1"></i>
                                                Coming soon: Network diagnostics, backup/restore, and advanced detection algorithms.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Footer Buttons */}
                        <div className="flex space-x-2 sm:space-x-3 p-4 sm:p-6 border-t border-gray-200 flex-shrink-0 bg-gray-50 rounded-b-xl">
                            <button 
                                type="button"
                                onClick={handleReset}
                                className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-3 sm:px-4 rounded-lg transition-colors text-sm sm:text-base"
                            >
                                Reset to Defaults
                            </button>
                            <button 
                                type="button"
                                onClick={onClose}
                                className="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 sm:px-4 rounded-lg transition-colors text-sm sm:text-base"
                            >
                                Cancel
                            </button>
                            <button 
                                type="button"
                                onClick={handleSave}
                                disabled={saving}
                                className="flex-1 bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300 text-white py-2 px-3 sm:px-4 rounded-lg transition-colors text-sm sm:text-base"
                            >
                                {saving ? (
                                    <><i className="fas fa-spinner fa-spin mr-2"></i>Saving...</>
                                ) : (
                                    <><i className="fas fa-save mr-2"></i>Save Changes</>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Manage People Modal Component
        function ManagePeopleModal({ knownPeople, onAddNew, onAddTraining, onClose, onRefresh }) {
            const [peopleStats, setPeopleStats] = useState({});

            useEffect(() => {
                // Simulate getting training image counts per person
                const stats = {};
                knownPeople.forEach(person => {
                    // This would ideally come from an API call
                    stats[person] = Math.floor(Math.random() * 3) + 1; // Mock data
                });
                setPeopleStats(stats);
            }, [knownPeople]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                        {/* Header */}
                        <div className="flex items-center justify-between p-6 border-b border-gray-200 flex-shrink-0">
                            <div>
                                <h3 className="text-xl font-bold text-gray-800">Manage People Database</h3>
                                <p className="text-sm text-gray-600">Add new people or additional training images</p>
                            </div>
                            <button 
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Content */}
                        <div className="p-6 overflow-y-auto flex-1 modal-scrollable">
                            {/* Action Buttons */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <button
                                    onClick={onAddNew}
                                    className="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg transition-colors flex items-center space-x-3"
                                >
                                    <div className="bg-blue-500 p-2 rounded-full">
                                        <i className="fas fa-user-plus text-xl"></i>
                                    </div>
                                    <div className="text-left">
                                        <div className="font-semibold">Add New Person</div>
                                        <div className="text-sm text-blue-100">Add someone new to the database</div>
                                    </div>
                                </button>

                                <button
                                    onClick={() => onAddTraining('')}
                                    className="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg transition-colors flex items-center space-x-3"
                                >
                                    <div className="bg-green-500 p-2 rounded-full">
                                        <i className="fas fa-camera text-xl"></i>
                                    </div>
                                    <div className="text-left">
                                        <div className="font-semibold">Add Training Image</div>
                                        <div className="text-sm text-green-100">Add more photos for existing people</div>
                                    </div>
                                </button>
                            </div>

                            {/* Current People */}
                            <div className="mb-6">
                                <h4 className="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                                    <i className="fas fa-users mr-2 text-gray-600"></i>
                                    Current People ({knownPeople.length})
                                </h4>
                                
                                {knownPeople.length > 0 ? (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {knownPeople.map((person, index) => (
                                            <div key={index} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                                <div className="flex items-center justify-between mb-3">
                                                    <div className="flex items-center space-x-3">
                                                        <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold">
                                                            {person.split(' ').map(n => n[0]).join('').toUpperCase()}
                                                        </div>
                                                        <div>
                                                            <div className="font-medium text-gray-800">{person}</div>
                                                            <div className="text-sm text-gray-500">
                                                                {peopleStats[person] || 1} training image(s)
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <button
                                                    onClick={() => onAddTraining(person)}
                                                    className="w-full bg-white hover:bg-gray-100 border border-gray-300 text-gray-700 py-2 px-3 rounded text-sm transition-colors flex items-center justify-center space-x-2"
                                                >
                                                    <i className="fas fa-plus"></i>
                                                    <span>Add Training Image</span>
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-8 text-gray-500">
                                        <i className="fas fa-user-friends text-4xl mb-4 text-gray-300"></i>
                                        <p className="text-lg">No people in database yet</p>
                                        <p className="text-sm">Add your first person to get started</p>
                                    </div>
                                )}
                            </div>

                            {/* Tips */}
                            <div className="bg-blue-50 rounded-lg p-4 border-l-4 border-blue-400">
                                <h5 className="font-medium text-blue-800 mb-2">
                                    <i className="fas fa-lightbulb mr-2"></i>
                                    Training Tips for Better Recognition
                                </h5>
                                <ul className="text-sm text-blue-700 space-y-1">
                                    <li>• Add 3-5 different photos per person for best accuracy</li>
                                    <li>• Include different angles, expressions, and lighting conditions</li>
                                    <li>• Use clear, high-quality images with visible faces</li>
                                    <li>• Photos with glasses, hats, or other accessories help robustness</li>
                                </ul>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="p-6 border-t border-gray-200 flex justify-between items-center flex-shrink-0">
                            <button
                                onClick={onRefresh}
                                className="text-gray-600 hover:text-gray-800 flex items-center space-x-2"
                            >
                                <i className="fas fa-refresh"></i>
                                <span>Refresh</span>
                            </button>
                            <button 
                                onClick={onClose}
                                className="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-lg transition-colors"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // Camera Capture Component
        function CameraCaptureModal({ onCapture, onClose }) {
            const [stream, setStream] = useState(null);
            const [capturedImages, setCapturedImages] = useState([]);
            const [currentStep, setCurrentStep] = useState(0);
            const [isCapturing, setIsCapturing] = useState(false);
            const [countdown, setCountdown] = useState(0);
            const videoRef = useRef(null);
            const canvasRef = useRef(null);

            const captureSteps = [
                { 
                    id: 'center', 
                    title: 'Look Straight Ahead', 
                    instruction: 'Look directly at the camera with a neutral expression',
                    icon: 'fas fa-dot-circle'
                },
                { 
                    id: 'left', 
                    title: 'Turn Head Left', 
                    instruction: 'Slowly turn your head to the left (about 30 degrees)',
                    icon: 'fas fa-arrow-left'
                },
                { 
                    id: 'right', 
                    title: 'Turn Head Right', 
                    instruction: 'Now turn your head to the right (about 30 degrees)',
                    icon: 'fas fa-arrow-right'
                },
                { 
                    id: 'up', 
                    title: 'Tilt Head Up', 
                    instruction: 'Tilt your head slightly upward',
                    icon: 'fas fa-arrow-up'
                },
                { 
                    id: 'down', 
                    title: 'Tilt Head Down', 
                    instruction: 'Tilt your head slightly downward',
                    icon: 'fas fa-arrow-down'
                }
            ];

            useEffect(() => {
                startCamera();
                return () => {
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            const startCamera = async () => {
                try {
                    const mediaStream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        },
                        audio: false
                    });
                    setStream(mediaStream);
                    if (videoRef.current) {
                        videoRef.current.srcObject = mediaStream;
                    }
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    alert('Could not access camera. Please check permissions.');
                }
            };

            const startCountdown = () => {
                setIsCapturing(true);
                setCountdown(3);
                
                const countdownInterval = setInterval(() => {
                    setCountdown(prev => {
                        if (prev <= 1) {
                            clearInterval(countdownInterval);
                            capturePhoto();
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);
            };

            const capturePhoto = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                
                if (video && canvas) {
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // Flip the image horizontally (mirror effect)
                    context.translate(canvas.width, 0);
                    context.scale(-1, 1);
                    context.drawImage(video, 0, 0);
                    
                    canvas.toBlob((blob) => {
                        const newImage = {
                            id: captureSteps[currentStep].id,
                            blob: blob,
                            dataUrl: canvas.toDataURL('image/jpeg', 0.8)
                        };
                        
                        setCapturedImages(prev => [...prev, newImage]);
                        
                        if (currentStep < captureSteps.length - 1) {
                            setCurrentStep(prev => prev + 1);
                        }
                        
                        setIsCapturing(false);
                    }, 'image/jpeg', 0.8);
                }
            };

            const retakePhoto = (stepIndex) => {
                setCapturedImages(prev => prev.filter(img => img.id !== captureSteps[stepIndex].id));
                setCurrentStep(stepIndex);
            };

            const finishCapture = () => {
                if (capturedImages.length > 0) {
                    // Use the center/first image as the primary one
                    const primaryImage = capturedImages.find(img => img.id === 'center') || capturedImages[0];
                    onCapture(primaryImage.blob, capturedImages);
                }
            };

            const getCurrentStepImage = () => {
                return capturedImages.find(img => img.id === captureSteps[currentStep].id);
            };

            const isAllCaptured = capturedImages.length === captureSteps.length;
            const currentStepCaptured = getCurrentStepImage();

            return (
                <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-60">
                    <div className="bg-white rounded-xl max-w-4xl w-full max-h-[95vh] overflow-hidden flex flex-col">
                        {/* Header */}
                        <div className="flex items-center justify-between p-6 border-b border-gray-200">
                            <div>
                                <h3 className="text-xl font-bold text-gray-800">Camera Capture</h3>
                                <p className="text-sm text-gray-600">
                                    Step {currentStep + 1} of {captureSteps.length}: {captureSteps[currentStep].title}
                                </p>
                            </div>
                            <button 
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Main Content */}
                        <div className="flex flex-1 overflow-hidden">
                            {/* Camera Section */}
                            <div className="flex-1 flex flex-col items-center justify-center p-6 bg-gray-900 relative">
                                {/* Video Feed */}
                                <div className="relative mb-4">
                                    <video 
                                        ref={videoRef}
                                        autoPlay 
                                        playsInline
                                        muted
                                        className="w-96 h-72 object-cover rounded-lg border-4 border-white shadow-lg mirror-video"
                                    />
                                    
                                    {/* Countdown Overlay */}
                                    {countdown > 0 && (
                                        <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-lg">
                                            <div className="text-6xl font-bold text-white animate-pulse">
                                                {countdown}
                                            </div>
                                        </div>
                                    )}

                                    {/* Face Guide Overlay */}
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <div className="w-48 h-64 border-2 border-dashed border-white opacity-50 rounded-full"></div>
                                    </div>
                                </div>

                                {/* Instruction */}
                                <div className="text-center text-white mb-4">
                                    <div className="flex items-center justify-center mb-2">
                                        <i className={`${captureSteps[currentStep].icon} text-3xl text-blue-400`}></i>
                                    </div>
                                    <h4 className="text-lg font-semibold mb-2">{captureSteps[currentStep].title}</h4>
                                    <p className="text-sm text-gray-300">{captureSteps[currentStep].instruction}</p>
                                </div>

                                {/* Capture Button */}
                                {!currentStepCaptured && (
                                    <button
                                        onClick={startCountdown}
                                        disabled={isCapturing}
                                        className="bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white px-8 py-3 rounded-full text-lg font-semibold transition-colors"
                                    >
                                        {isCapturing ? (
                                            <><i className="fas fa-spinner fa-spin mr-2"></i>Capturing...</>
                                        ) : (
                                            <><i className="fas fa-camera mr-2"></i>Capture Photo</>
                                        )}
                                    </button>
                                )}

                                {currentStepCaptured && (
                                    <div className="flex space-x-3">
                                        <button
                                            onClick={() => retakePhoto(currentStep)}
                                            className="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg transition-colors"
                                        >
                                            <i className="fas fa-redo mr-2"></i>Retake
                                        </button>
                                        
                                        {currentStep < captureSteps.length - 1 ? (
                                            <button
                                                onClick={() => setCurrentStep(prev => prev + 1)}
                                                className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors"
                                            >
                                                Next <i className="fas fa-arrow-right ml-2"></i>
                                            </button>
                                        ) : (
                                            <button
                                                onClick={finishCapture}
                                                className="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors"
                                            >
                                                <i className="fas fa-check mr-2"></i>Finish
                                            </button>
                                        )}
                                    </div>
                                )}

                                <canvas ref={canvasRef} className="hidden" />
                            </div>

                            {/* Progress Section */}
                            <div className="w-80 bg-gray-50 p-6 border-l border-gray-200 overflow-y-auto">
                                <h4 className="text-lg font-semibold text-gray-800 mb-4">
                                    <i className="fas fa-list-check mr-2"></i>
                                    Capture Progress
                                </h4>

                                {/* Progress Steps */}
                                <div className="space-y-4">
                                    {captureSteps.map((step, index) => {
                                        const captured = capturedImages.find(img => img.id === step.id);
                                        const isCurrent = index === currentStep;
                                        
                                        return (
                                            <div key={step.id} className={`p-3 rounded-lg border transition-colors ${
                                                captured ? 'bg-green-50 border-green-200' :
                                                isCurrent ? 'bg-blue-50 border-blue-200' : 'bg-gray-100 border-gray-200'
                                            }`}>
                                                <div className="flex items-center space-x-3">
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                                                        captured ? 'bg-green-500 text-white' :
                                                        isCurrent ? 'bg-blue-500 text-white' : 'bg-gray-300 text-gray-600'
                                                    }`}>
                                                        {captured ? (
                                                            <i className="fas fa-check text-sm"></i>
                                                        ) : (
                                                            <i className={`${step.icon} text-sm`}></i>
                                                        )}
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className={`font-medium ${
                                                            captured ? 'text-green-800' :
                                                            isCurrent ? 'text-blue-800' : 'text-gray-700'
                                                        }`}>
                                                            {step.title}
                                                        </div>
                                                        {captured && (
                                                            <div className="text-xs text-green-600">✓ Captured</div>
                                                        )}
                                                        {isCurrent && !captured && (
                                                            <div className="text-xs text-blue-600">→ Current</div>
                                                        )}
                                                    </div>
                                                    {captured && (
                                                        <button
                                                            onClick={() => retakePhoto(index)}
                                                            className="text-yellow-600 hover:text-yellow-700 text-sm"
                                                            title="Retake this photo"
                                                        >
                                                            <i className="fas fa-redo"></i>
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* Captured Images Preview */}
                                {capturedImages.length > 0 && (
                                    <div className="mt-6">
                                        <h5 className="text-sm font-medium text-gray-700 mb-3">Captured Images</h5>
                                        <div className="grid grid-cols-2 gap-2">
                                            {capturedImages.map((img, index) => (
                                                <div key={img.id} className="relative">
                                                    <img 
                                                        src={img.dataUrl} 
                                                        alt={`Captured ${img.id}`}
                                                        className="w-full h-20 object-cover rounded border"
                                                    />
                                                    <div className="absolute bottom-1 left-1 bg-black bg-opacity-70 text-white text-xs px-1 rounded">
                                                        {captureSteps.find(s => s.id === img.id)?.title}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* Tips */}
                                <div className="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <h6 className="text-sm font-medium text-yellow-800 mb-2">
                                        <i className="fas fa-lightbulb mr-1"></i>Tips
                                    </h6>
                                    <ul className="text-xs text-yellow-700 space-y-1">
                                        <li>• Keep your face centered in the oval guide</li>
                                        <li>• Move slowly and hold each position</li>
                                        <li>• Ensure good lighting on your face</li>
                                        <li>• Remove glasses if possible for better detection</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="p-4 border-t border-gray-200 bg-gray-50 flex justify-between items-center">
                            <div className="text-sm text-gray-600">
                                {capturedImages.length} of {captureSteps.length} photos captured
                            </div>
                            <div className="flex space-x-3">
                                <button 
                                    onClick={onClose}
                                    className="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors"
                                >
                                    Cancel
                                </button>
                                {isAllCaptured && (
                                    <button 
                                        onClick={finishCapture}
                                        className="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-lg transition-colors"
                                    >
                                        <i className="fas fa-check mr-2"></i>Use Photos
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Add Person Direct Modal Component  
        function AddPersonDirectModal({ knownPeople, onAdd, onClose, onSuccess }) {
            const [mode, setMode] = useState('new'); // 'new' or 'training'
            const [selectedPerson, setSelectedPerson] = useState('');
            const [personName, setPersonName] = useState('');
            const [selectedFile, setSelectedFile] = useState(null);
            const [preview, setPreview] = useState(null);
            const [uploading, setUploading] = useState(false);
            const [captureMode, setCaptureMode] = useState('upload'); // 'upload' or 'camera'
            const [showCameraCapture, setShowCameraCapture] = useState(false);
            const fileInputRef = useRef(null);

            const handleFileSelect = (event) => {
                const file = event.target.files[0];
                if (file) {
                    setSelectedFile(file);
                    
                    // Create preview
                    const reader = new FileReader();
                    reader.onload = (e) => setPreview(e.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleCameraCapture = (primaryBlob, allImages) => {
                // Store all captured images for potential batch upload
                setSelectedFile({ primary: primaryBlob, all: allImages });
                
                // Create preview from the primary image
                const reader = new FileReader();
                reader.onload = (e) => setPreview(e.target.result);
                reader.readAsDataURL(primaryBlob);
                
                setShowCameraCapture(false);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!selectedFile) {
                    alert('Please select an image');
                    return;
                }

                if (mode === 'new' && !personName.trim()) {
                    alert('Please enter a person name');
                    return;
                }

                if (mode === 'training' && !selectedPerson) {
                    alert('Please select a person');
                    return;
                }

                setUploading(true);

                try {
                    const formData = new FormData();
                    const name = mode === 'new' ? personName.trim() : selectedPerson;
                    
                    // Check if it's camera capture with multiple images
                    if (captureMode === 'camera' && selectedFile.all && selectedFile.all.length > 1) {
                        // Upload multiple images from camera capture
                        formData.append('name', name);
                        selectedFile.all.forEach((img, index) => {
                            formData.append(`image_${index}`, img.blob, `${name}_${img.id}.jpg`);
                        });
                        
                        const response = await fetch('/api/add-multiple-training-images', {
                            method: 'POST',
                            body: formData
                        });
                        const result = await response.json();
                        
                        if (result.success) {
                            alert(result.message);
                            onSuccess();
                        } else {
                            alert('Error: ' + result.message);
                        }
                    } else {
                        // Single image upload (either file upload or single camera capture)
                        const imageFile = selectedFile.primary || selectedFile;
                        formData.append('image', imageFile);
                        formData.append('name', name);

                        const result = await onAdd(formData, mode === 'training');
                        
                        if (result.success) {
                            alert(result.message);
                            onSuccess();
                        } else {
                            alert('Error: ' + result.message);
                        }
                    }
                } catch (error) {
                    alert('Failed to upload image');
                } finally {
                    setUploading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl max-w-lg w-full p-6">
                        <div className="flex items-center justify-between mb-6">
                            <h3 className="text-lg font-bold text-gray-800">
                                {mode === 'new' ? 'Add New Person' : 'Add Training Image'}
                            </h3>
                            <button 
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        {/* Mode Selection */}
                        <div className="mb-6">
                            <div className="flex space-x-4">
                                <button
                                    onClick={() => setMode('new')}
                                    className={`flex-1 p-3 rounded-lg border transition-colors ${
                                        mode === 'new' 
                                            ? 'bg-blue-50 border-blue-500 text-blue-700' 
                                            : 'bg-gray-50 border-gray-300 text-gray-600 hover:bg-gray-100'
                                    }`}
                                >
                                    <i className="fas fa-user-plus mr-2"></i>
                                    New Person
                                </button>
                                <button
                                    onClick={() => setMode('training')}
                                    className={`flex-1 p-3 rounded-lg border transition-colors ${
                                        mode === 'training' 
                                            ? 'bg-green-50 border-green-500 text-green-700' 
                                            : 'bg-gray-50 border-gray-300 text-gray-600 hover:bg-gray-100'
                                    }`}
                                >
                                    <i className="fas fa-camera mr-2"></i>
                                    Training Image
                                </button>
                            </div>
                        </div>

                        <form onSubmit={handleSubmit}>
                            {/* Person Selection/Input */}
                            {mode === 'new' ? (
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Person Name
                                    </label>
                                    <input 
                                        type="text"
                                        value={personName}
                                        onChange={(e) => setPersonName(e.target.value)}
                                        placeholder="Enter full name..."
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                            ) : (
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Select Person
                                    </label>
                                    {knownPeople.length > 0 ? (
                                        <select 
                                            value={selectedPerson}
                                            onChange={(e) => setSelectedPerson(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                            required
                                        >
                                            <option value="">Choose a person...</option>
                                            {knownPeople.map((person, index) => (
                                                <option key={index} value={person}>{person}</option>
                                            ))}
                                        </select>
                                    ) : (
                                        <p className="text-gray-500 text-sm p-3 bg-gray-100 rounded">
                                            No people in database. Add a new person first.
                                        </p>
                                    )}
                                </div>
                            )}

                            {/* Image Source Selection */}
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    How would you like to add the image?
                                </label>
                                <div className="flex space-x-4">
                                    <button
                                        type="button"
                                        onClick={() => setCaptureMode('upload')}
                                        className={`flex-1 p-3 rounded-lg border transition-colors ${
                                            captureMode === 'upload' 
                                                ? 'bg-blue-50 border-blue-500 text-blue-700' 
                                                : 'bg-gray-50 border-gray-300 text-gray-600 hover:bg-gray-100'
                                        }`}
                                    >
                                        <i className="fas fa-cloud-upload-alt mr-2"></i>
                                        Upload from Device
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setCaptureMode('camera')}
                                        className={`flex-1 p-3 rounded-lg border transition-colors ${
                                            captureMode === 'camera' 
                                                ? 'bg-green-50 border-green-500 text-green-700' 
                                                : 'bg-gray-50 border-gray-300 text-gray-600 hover:bg-gray-100'
                                        }`}
                                    >
                                        <i className="fas fa-camera mr-2"></i>
                                        Take Photos
                                    </button>
                                </div>
                            </div>

                            {/* Image Upload/Capture */}
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    {captureMode === 'upload' ? 'Upload Image' : 'Capture Photos'}
                                </label>
                                
                                {captureMode === 'upload' ? (
                                    <div 
                                        onClick={() => fileInputRef.current?.click()}
                                        className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-gray-400 transition-colors"
                                    >
                                        {preview ? (
                                            <div className="space-y-3">
                                                <img 
                                                    src={preview} 
                                                    alt="Preview" 
                                                    className="max-h-32 mx-auto rounded"
                                                />
                                                <p className="text-sm text-gray-600">Click to change image</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                <i className="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>
                                                <div>
                                                    <p className="text-sm text-gray-600">Click to upload an image</p>
                                                    <p className="text-xs text-gray-500">JPG, PNG, or BMP files</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div>
                                        {preview ? (
                                            <div className="space-y-4">
                                                <div className="border-2 border-green-300 rounded-lg p-4 bg-green-50">
                                                    <img 
                                                        src={preview} 
                                                        alt="Captured Preview" 
                                                        className="max-h-32 mx-auto rounded"
                                                    />
                                                    <p className="text-sm text-green-700 text-center mt-2">
                                                        ✓ Photos captured successfully
                                                    </p>
                                                </div>
                                                <button
                                                    type="button"
                                                    onClick={() => setShowCameraCapture(true)}
                                                    className="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors"
                                                >
                                                    <i className="fas fa-camera mr-2"></i>Retake Photos
                                                </button>
                                            </div>
                                        ) : (
                                            <button
                                                type="button"
                                                onClick={() => setShowCameraCapture(true)}
                                                className="w-full border-2 border-dashed border-green-300 rounded-lg p-6 text-center cursor-pointer hover:border-green-400 transition-colors bg-green-50"
                                            >
                                                <div className="space-y-3">
                                                    <i className="fas fa-camera text-3xl text-green-600"></i>
                                                    <div>
                                                        <p className="text-sm text-green-700 font-medium">Click to start camera capture</p>
                                                        <p className="text-xs text-green-600">Guided photo session with multiple angles</p>
                                                    </div>
                                                </div>
                                            </button>
                                        )}
                                    </div>
                                )}
                                
                                <input 
                                    ref={fileInputRef}
                                    type="file"
                                    accept="image/*"
                                    onChange={handleFileSelect}
                                    className="hidden"
                                />
                            </div>

                            {/* Submit Buttons */}
                            <div className="flex space-x-3">
                                <button 
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors"
                                >
                                    Cancel
                                </button>
                                <button 
                                    type="submit"
                                    disabled={uploading}
                                    className={`flex-1 py-2 px-4 rounded-lg transition-colors text-white ${
                                        mode === 'new' 
                                            ? 'bg-blue-600 hover:bg-blue-700 disabled:bg-blue-300' 
                                            : 'bg-green-600 hover:bg-green-700 disabled:bg-green-300'
                                    }`}
                                >
                                    {uploading ? (
                                        <><i className="fas fa-spinner fa-spin mr-2"></i>Uploading...</>
                                    ) : mode === 'new' ? (
                                        <><i className="fas fa-user-plus mr-2"></i>Add Person</>
                                    ) : (
                                        <><i className="fas fa-camera mr-2"></i>Add Training Image</>
                                    )}
                                </button>
                            </div>
                        </form>

                        {/* Camera Capture Modal */}
                        {showCameraCapture && (
                            <CameraCaptureModal 
                                onCapture={handleCameraCapture}
                                onClose={() => setShowCameraCapture(false)}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // Add Person Modal Component
        function AddPersonModal({ unknown, knownPeople, onAdd, onClose }) {
            const [name, setName] = useState('');
            const [action, setAction] = useState('new');
            const [selectedPerson, setSelectedPerson] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (action === 'new' && name.trim()) {
                    onAdd(name.trim(), 'new');
                } else if (action === 'existing' && selectedPerson) {
                    onAdd(selectedPerson, 'existing');
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-xl max-w-lg w-full p-6 modal-content">
                        <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-bold text-gray-800">Identify Unknown Person</h3>
                            <button 
                                onClick={onClose}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <i className="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        
                        <div className="mb-6">
                            <div className="aspect-square w-32 mx-auto rounded-lg overflow-hidden bg-gray-200 mb-4">
                                <img 
                                    src={`data:image/jpeg;base64,${unknown.image_data}`}
                                    alt="Unknown Person"
                                    className="w-full h-full object-cover"
                                />
                            </div>
                            <p className="text-sm text-gray-600 text-center">
                                First detected: {new Date(unknown.timestamp).toLocaleString()}
                            </p>
                        </div>

                        {/* Action Selection */}
                        <div className="mb-6">
                            <p className="text-sm font-medium text-gray-700 mb-3">Choose an action:</p>
                            <div className="space-y-3">
                                <label className="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input 
                                        type="radio"
                                        name="action"
                                        value="existing"
                                        checked={action === 'existing'}
                                        onChange={(e) => setAction(e.target.value)}
                                        className="mr-3"
                                    />
                                    <div>
                                        <div className="font-medium text-green-700">
                                            <i className="fas fa-link mr-2"></i>
                                            Link to existing person
                                        </div>
                                        <div className="text-sm text-gray-600">
                                            Add this as another training image for someone already in the database
                                        </div>
                                    </div>
                                </label>

                                <label className="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                    <input 
                                        type="radio"
                                        name="action"
                                        value="new"
                                        checked={action === 'new'}
                                        onChange={(e) => setAction(e.target.value)}
                                        className="mr-3"
                                    />
                                    <div>
                                        <div className="font-medium text-blue-700">
                                            <i className="fas fa-user-plus mr-2"></i>
                                            Create new person
                                        </div>
                                        <div className="text-sm text-gray-600">
                                            Add this person as a new entry in the database
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <form onSubmit={handleSubmit}>
                            {action === 'existing' ? (
                                <div className="mb-4">
                                    <label htmlFor="existingPerson" className="block text-sm font-medium text-gray-700 mb-2">
                                        Select existing person
                                    </label>
                                    {knownPeople && knownPeople.length > 0 ? (
                                        <select 
                                            id="existingPerson"
                                            value={selectedPerson}
                                            onChange={(e) => setSelectedPerson(e.target.value)}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                            required
                                        >
                                            <option value="">Choose a person...</option>
                                            {knownPeople.map((person, index) => (
                                                <option key={index} value={person}>{person}</option>
                                            ))}
                                        </select>
                                    ) : (
                                        <p className="text-gray-500 text-sm p-3 bg-gray-100 rounded">
                                            No known people found. Create a new person instead.
                                        </p>
                                    )}
                                </div>
                            ) : (
                                <div className="mb-4">
                                    <label htmlFor="personName" className="block text-sm font-medium text-gray-700 mb-2">
                                        Person's Name
                                    </label>
                                    <input 
                                        type="text"
                                        id="personName"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        placeholder="Enter full name..."
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        required
                                    />
                                </div>
                            )}
                            
                            <div className="flex space-x-3">
                                <button 
                                    type="button"
                                    onClick={onClose}
                                    className="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg transition-colors"
                                >
                                    Cancel
                                </button>
                                <button 
                                    type="submit"
                                    className={`flex-1 py-2 px-4 rounded-lg transition-colors text-white ${
                                        action === 'existing' 
                                            ? 'bg-green-600 hover:bg-green-700' 
                                            : 'bg-blue-600 hover:bg-blue-700'
                                    }`}
                                >
                                    {action === 'existing' ? (
                                        <><i className="fas fa-link mr-2"></i>Link Person</>
                                    ) : (
                                        <><i className="fas fa-user-plus mr-2"></i>Add New Person</>
                                    )}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // Render the app using React 18 createRoot
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PPEDashboard />);
    </script>
</body>
</html> 